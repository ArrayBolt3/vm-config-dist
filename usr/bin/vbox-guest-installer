#!/bin/bash

set -x
set -e

virtualbox_guest_additions_packages_still_installed() {
   echo "$0 ERROR: VirtualBox guest additions Debian package still installed." >&2
   echo "$0 ERROR: Will not install VirtualBox guest additions from virtualbox-guest-additions-iso." >&2
   echo "$0 ERROR: To remove, run:" >&2
   echo "sudo apt purge virtualbox-guest-x11 virtualbox-guest-utils virtualbox-guest-dkms" >&2
   exit 0
}

if dpkg-query --show "virtualbox-guest-x11" &>/dev/null ; then
   virtualbox_guest_additions_packages_still_installed
fi
if dpkg-query --show "virtualbox-guest-utils" &>/dev/null ; then
   virtualbox_guest_additions_packages_still_installed
fi
if dpkg-query --show "virtualbox-guest-dkms" &>/dev/null ; then
   virtualbox_guest_additions_packages_still_installed
fi

if ! dpkg-query --show "virtualbox-guest-additions-iso" &>/dev/null ; then
   echo "$0 ERROR: package virtualbox-guest-additions-iso not installed! To install, run:" >&2
   echo "sudo apt update" >&2
   echo "sudo apt install virtualbox-guest-additions-iso" >&2
   exit 0
fi

rm -rf /var/cache/vm-config-dist/vbox-guest-additions-extracted-iso
rm -rf /var/cache/vm-config-dist/vbox-guest-additions-extracted-makeself

mkdir -p /var/cache/vm-config-dist/vbox-guest-additions-extracted-iso

pushd /var/cache/vm-config-dist/vbox-guest-additions-extracted-iso >/dev/null

7z x -o/var/cache/vm-config-dist/vbox-guest-additions-extracted-iso /usr/share/virtualbox/VBoxGuestAdditions.iso >/dev/null

chmod +x VBoxLinuxAdditions.run

./VBoxLinuxAdditions.run --check >/dev/null

## Could run VBoxLinuxAdditions.run directly but extracting it allows easier debugging in case of failure.
#./VBoxLinuxAdditions.run

./VBoxLinuxAdditions.run --noexec --keep --target /var/cache/vm-config-dist/vbox-guest-additions-extracted-makeself

popd >/dev/null

pushd /var/cache/vm-config-dist/vbox-guest-additions-extracted-makeself >/dev/null

if ./install.sh ; then
   echo "$0 INFO: Success, vm-config-dist installed VirtualBox guest additions."
else
   echo "$0 ERROR: vm-config-dist failed to install VirtualBox guest additions. See:" >&2
   echo "https://www.whonix.org/wiki/ga" >&2
fi

popd >/dev/null

exit 0
